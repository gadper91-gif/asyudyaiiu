local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local Workspace = game:GetService("Workspace")
local HttpService = game:GetService("HttpService")
local TeleportService = game:GetService("TeleportService")
local TweenService = game:GetService("TweenService")
local StatsService = game:GetService("Stats")

local localPlayer = Players.LocalPlayer
local camera = Workspace.CurrentCamera

-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
local DEFAULT_SETTINGS = {
    AIM_KEY = Enum.UserInputType.MouseButton2,
    AIM_PART = "HumanoidRootPart",
    SMOOTHNESS = 0.3,
    MAX_DISTANCE = 65,
    FOV_ANGLE = 90,
    MAX_RADIUS = 200,
    PRIORITIZE_CLOSEST = false,
    PRIORITIZE_LIMBS = true,
    SHOW_RADIUS_CIRCLE = true,
    CIRCLE_TRANSPARENCY = 0.7,
    OBSTACLE_CHECK = true,
    CAMERA_FOV = 70, -- –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª–µ –¥–ª—è FOV –∫–∞–º–µ—Ä—ã
    WEBHOOK_URL = "https://discord.com/api/webhooks/1438975131039961242/hh8tHiH68Omnj4w4Jm4QXwlC0fg-RCQS2MwUud0YV7K_OJhlvsd4K_AUu-r2gRT-BrSv",
    BOT_USER_ID = "1438980529226649682"
}

-- –ò–º—è —Ñ–∞–π–ª–∞ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫
local SETTINGS_FILENAME = "aimlock_settings.json"

-- –°–Ω–∞—á–∞–ª–∞ –æ–±—ä—è–≤–ª—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é SETTINGS
local SETTINGS = {}

-- –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫
function saveSettings()
    local success, result = pcall(function()
        -- –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ —Ç–∞–±–ª–∏—Ü—É, –∫–æ—Ç–æ—Ä—É—é –º–æ–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ JSON
        local saveData = {
            SMOOTHNESS = SETTINGS.SMOOTHNESS,
            MAX_DISTANCE = SETTINGS.MAX_DISTANCE,
            FOV_ANGLE = SETTINGS.FOV_ANGLE,
            MAX_RADIUS = SETTINGS.MAX_RADIUS,
            PRIORITIZE_CLOSEST = SETTINGS.PRIORITIZE_CLOSEST,
            PRIORITIZE_LIMBS = SETTINGS.PRIORITIZE_LIMBS,
            SHOW_RADIUS_CIRCLE = SETTINGS.SHOW_RADIUS_CIRCLE,
            CIRCLE_TRANSPARENCY = SETTINGS.CIRCLE_TRANSPARENCY,
            OBSTACLE_CHECK = SETTINGS.OBSTACLE_CHECK,
            CAMERA_FOV = SETTINGS.CAMERA_FOV -- –°–æ—Ö—Ä–∞–Ω—è–µ–º FOV –∫–∞–º–µ—Ä—ã
        }
        
        local jsonData = HttpService:JSONEncode(saveData)
        if writefile then
            writefile(SETTINGS_FILENAME, jsonData)
            return true
        else
            print("‚ùå writefile not available, settings not saved")
            return false
        end
    end)
    
    if not success then
        warn("Failed to save settings: " .. tostring(result))
        return false
    end
    
    return true
end

function loadSettings()
    local success, result = pcall(function()
        if not isfile or not isfile(SETTINGS_FILENAME) then
            return nil
        end
        
        local jsonData = readfile(SETTINGS_FILENAME)
        local loadedSettings = HttpService:JSONDecode(jsonData)
        
        -- –û–±—ä–µ–¥–∏–Ω—è–µ–º –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        local mergedSettings = {}
        for key, value in pairs(DEFAULT_SETTINGS) do
            mergedSettings[key] = loadedSettings[key] or value
        end
        
        return mergedSettings
    end)
    
    if not success then
        warn("Failed to load settings: " .. tostring(result))
        return nil
    end
    
    return result
end

-- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
local loadedSettings = loadSettings()
if loadedSettings then
    SETTINGS = loadedSettings
    -- –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π FOV –∫–∞–º–µ—Ä—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    if SETTINGS.CAMERA_FOV then
        camera.FieldOfView = SETTINGS.CAMERA_FOV
    end
    print("üíæ Settings loaded from file!")
else
    SETTINGS = DEFAULT_SETTINGS
    print("‚öôÔ∏è Using default settings")
end

local isAiming = false
local aimConnection = nil
local currentCrosshair = nil
local watermark = nil
local infoGui = nil
local mouse = localPlayer:GetMouse()
local lastWebhookCheck = 0
local webhookCheckCooldown = 10 -- seconds

-- Store all connections and objects for cleanup
local connections = {}
local createdObjects = {}

-- –§–∏–æ–ª–µ—Ç–æ–≤—ã–π —Ü–≤–µ—Ç (RGB: 182, 39, 246)
local PURPLE_COLOR = Color3.fromRGB(182, 39, 246)

-- –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –Ω–æ–≤–æ–≥–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞
local respawnToggle = false
local me = localPlayer

-- –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–∏–Ω–≥–∞
function getPing()
    local stats = StatsService:FindFirstChild("PerformanceStats")
    if stats then
        local pingStat = stats:FindFirstChild("Ping")
        if pingStat then
            return math.floor(pingStat:GetValue())
        end
    end
    return 0
end

-- –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –º–∏–Ω–∏-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
function showNotification(title, status, duration)
    duration = duration or 3
    
    local screenGui = Instance.new("ScreenGui")
    screenGui.Name = "NotificationGui"
    screenGui.Parent = game.CoreGui
    screenGui.ResetOnSpawn = false
    
    local notificationFrame = Instance.new("Frame")
    notificationFrame.Size = UDim2.new(0, 200, 0, 80)
    notificationFrame.Position = UDim2.new(1, 10, 0.3, 0) -- Start off-screen to the right
    notificationFrame.AnchorPoint = Vector2.new(1, 0)
    notificationFrame.BackgroundColor3 = Color3.new(0.1, 0.1, 0.1)
    notificationFrame.BackgroundTransparency = 0.2
    notificationFrame.BorderSizePixel = 0
    notificationFrame.Parent = screenGui
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 8)
    corner.Parent = notificationFrame
    
    local stroke = Instance.new("UIStroke")
    stroke.Color = PURPLE_COLOR
    stroke.Thickness = 2
    stroke.Parent = notificationFrame
    
    local titleLabel = Instance.new("TextLabel")
    titleLabel.Size = UDim2.new(1, -20, 0, 25)
    titleLabel.Position = UDim2.new(0, 10, 0, 10)
    titleLabel.BackgroundTransparency = 1
    titleLabel.TextColor3 = Color3.new(1, 1, 1)
    titleLabel.Text = title
    titleLabel.Font = Enum.Font.GothamBold
    titleLabel.TextSize = 16
    titleLabel.TextXAlignment = Enum.TextXAlignment.Left
    titleLabel.TextYAlignment = Enum.TextYAlignment.Center
    titleLabel.Parent = notificationFrame
    
    local statusLabel = Instance.new("TextLabel")
    statusLabel.Size = UDim2.new(1, -20, 0, 30)
    statusLabel.Position = UDim2.new(0, 10, 0, 40)
    statusLabel.BackgroundTransparency = 1
    statusLabel.TextColor3 = status and Color3.fromRGB(0, 255, 0) or Color3.fromRGB(255, 50, 50)
    statusLabel.Text = status and "ENABLED" or "DISABLED"
    statusLabel.Font = Enum.Font.GothamBold
    statusLabel.TextSize = 18
    statusLabel.TextXAlignment = Enum.TextXAlignment.Left
    statusLabel.TextYAlignment = Enum.TextYAlignment.Center
    statusLabel.Parent = notificationFrame
    
    -- –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è
    local slideIn = TweenService:Create(
        notificationFrame,
        TweenInfo.new(0.3, Enum.EasingStyle.Quad, Enum.EasingDirection.Out),
        {Position = UDim2.new(1, -10, 0.3, 0)}
    )
    
    slideIn:Play()
    
    -- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–∫—Ä—ã—Ç–∏–µ —á–µ—Ä–µ–∑ —É–∫–∞–∑–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è
    delay(duration, function()
        local slideOut = TweenService:Create(
            notificationFrame,
            TweenInfo.new(0.3, Enum.EasingStyle.Quad, Enum.EasingDirection.Out),
            {Position = UDim2.new(1, 10, 0.3, 0)}
        )
        
        slideOut:Play()
        
        delay(0.35, function()
            screenGui:Destroy()
        end)
    end)
    
    return screenGui
end

-- –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ FOV –∫–∞–º–µ—Ä—ã
function setCameraFOV(newFOV)
    if newFOV and newFOV >= 1 and newFOV <= 120 then
        SETTINGS.CAMERA_FOV = newFOV
        camera.FieldOfView = newFOV
        saveSettings() -- –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
        print("üéØ Camera FOV updated to: " .. newFOV .. "¬∞")
        return true
    else
        print("‚ùå Invalid FOV. Must be between 1 and 120")
        return false
    end
end

-- Webhook functions
function sendWebhook(message)
    local success, result = pcall(function()
        local data = {
            ["content"] = message,
            ["username"] = "Aimlock by Nova",
            ["avatar_url"] = "https://i.imgur.com/6Jq7Z2C.png"
        }
        
        local jsonData = HttpService:JSONEncode(data)
        
        local response = request({
            Url = SETTINGS.WEBHOOK_URL,
            Method = "POST",
            Headers = {
                ["Content-Type"] = "application/json"
            },
            Body = jsonData
        })
        
        return response
    end)
    
    if not success then
        warn("Webhook error: " .. tostring(result))
    end
    
    return success
end

function sendStartupWebhook()
    local gameInfo = {
        GameName = game:GetService("MarketplaceService"):GetProductInfo(game.PlaceId).Name,
        PlaceId = game.PlaceId,
        JobId = game.JobId,
        PlayerName = localPlayer.Name,
        PlayerDisplayName = localPlayer.DisplayName
    }
    
    local message = string.format("üéØ **Aimlock Activated**\n**Player:** %s (%s)\n**Game:** %s\n**Place ID:** %s\n**Server:** %s\n**Time:** %s",
        gameInfo.PlayerDisplayName,
        gameInfo.PlayerName,
        gameInfo.GameName,
        gameInfo.PlaceId,
        gameInfo.JobId,
        os.date("%Y-%m-%d %H:%M:%S")
    )
    
    sendWebhook(message)
end

function getWebhookMessages()
    local success, result = pcall(function()
        local response = request({
            Url = SETTINGS.WEBHOOK_URL .. "/messages?limit=5",
            Method = "GET",
            Headers = {
                ["Content-Type"] = "application/json"
            }
        })
        
        if response and response.Success then
            return HttpService:JSONDecode(response.Body)
        end
        return nil
    end)
    
    if not success then
        warn("Webhook fetch error: " .. tostring(result))
    end
    
    return success and result or nil
end

function checkForBotCommands()
    local now = tick()
    if now - lastWebhookCheck < webhookCheckCooldown then
        return
    end
    
    lastWebhookCheck = now
    
    local messages = getWebhookMessages()
    if not messages then return end
    
    for _, message in ipairs(messages) do
        if message.author and message.author.id == SETTINGS.BOT_USER_ID then
            local content = message.content:lower()
            local playerName = localPlayer.Name:lower()
            local playerDisplayName = localPlayer.DisplayName:lower()
            
            if content:find(playerName) or content:find(playerDisplayName) or content:find(localPlayer.UserId) then
                print("üö® Bot command detected! Leaving server...")
                sendWebhook(string.format("‚ö†Ô∏è **Player %s (%s) leaving server by bot command**", 
                    localPlayer.DisplayName, localPlayer.Name))
                
                delay(2, function()
                    localPlayer:Kick("Bot command received")
                end)
                
                return true
            end
        end
    end
    
    return false
end

function createWatermark()
    if watermark then
        watermark.Gui:Destroy()
    end
    
    local screenGui = Instance.new("ScreenGui")
    screenGui.Name = "AimlockWatermark"
    screenGui.Parent = game.CoreGui
    screenGui.ResetOnSpawn = false
    
    table.insert(createdObjects, screenGui)
    
    local watermarkFrame = Instance.new("Frame")
    watermarkFrame.Size = UDim2.new(0, 250, 0, 35)
    watermarkFrame.Position = UDim2.new(0, 10, 1, -45)
    watermarkFrame.BackgroundColor3 = Color3.new(0, 0, 0)
    watermarkFrame.BackgroundTransparency = 0.7
    watermarkFrame.BorderSizePixel = 0
    watermarkFrame.Parent = screenGui
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 6)
    corner.Parent = watermarkFrame
    
    local watermarkLabel = Instance.new("TextLabel")
    watermarkLabel.Size = UDim2.new(0, 140, 1, 0)
    watermarkLabel.Position = UDim2.new(0, 5, 0, 0)
    watermarkLabel.BackgroundTransparency = 1
    watermarkLabel.TextColor3 = Color3.new(1, 1, 1)
    watermarkLabel.Text = "aimlock by slrNova"
    watermarkLabel.Font = Enum.Font.GothamBold
    watermarkLabel.TextSize = 14
    watermarkLabel.TextXAlignment = Enum.TextXAlignment.Left
    watermarkLabel.TextYAlignment = Enum.TextYAlignment.Center
    watermarkLabel.Parent = watermarkFrame
    
    local separatorLabel = Instance.new("TextLabel")
    separatorLabel.Size = UDim2.new(0, 20, 1, 0)
    separatorLabel.Position = UDim2.new(0, 145, 0, 0)
    separatorLabel.BackgroundTransparency = 1
    separatorLabel.TextColor3 = Color3.new(0.8, 0.8, 0.8)
    separatorLabel.Text = "|"
    separatorLabel.Font = Enum.Font.GothamBold
    separatorLabel.TextSize = 14
    separatorLabel.TextXAlignment = Enum.TextXAlignment.Center
    separatorLabel.TextYAlignment = Enum.TextYAlignment.Center
    separatorLabel.Parent = watermarkFrame
    
    local pingLabel = Instance.new("TextLabel")
    pingLabel.Size = UDim2.new(0, 80, 1, 0)
    pingLabel.Position = UDim2.new(0, 165, 0, 0)
    pingLabel.BackgroundTransparency = 1
    pingLabel.TextColor3 = Color3.new(1, 1, 1)
    pingLabel.Text = "Ping: 0ms"
    pingLabel.Font = Enum.Font.GothamBold
    pingLabel.TextSize = 14
    pingLabel.TextXAlignment = Enum.TextXAlignment.Left
    pingLabel.TextYAlignment = Enum.TextYAlignment.Center
    pingLabel.Parent = watermarkFrame
    
    -- –°–æ–∑–¥–∞–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–∏–Ω–≥–∞
    local pingConnection
    pingConnection = RunService.Heartbeat:Connect(function()
        if pingLabel and pingLabel.Parent then
            local ping = getPing()
            -- –¶–≤–µ—Ç –ø–∏–Ω–≥–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∑–Ω–∞—á–µ–Ω–∏—è
            if ping < 90 then
                pingLabel.TextColor3 = Color3.fromRGB(0, 255, 0) -- –ó–µ–ª–µ–Ω—ã–π
            elseif ping < 185 then
                pingLabel.TextColor3 = Color3.fromRGB(255, 255, 0) -- –ñ–µ–ª—Ç—ã–π
            else
                pingLabel.TextColor3 = Color3.fromRGB(255, 50, 50) -- –ö—Ä–∞—Å–Ω—ã–π
            end
            pingLabel.Text = "Ping: " .. ping .. "ms"
        else
            if pingConnection then
                pingConnection:Disconnect()
            end
        end
    end)
    
    table.insert(connections, pingConnection)
    
    watermark = {
        Gui = screenGui,
        Frame = watermarkFrame,
        Label = watermarkLabel,
        PingLabel = pingLabel
    }
    
    return watermark
end

function updateWatermarkColor()
    if not watermark or not watermark.Label then 
        createWatermark()
        return 
    end
    
    if isAiming then
        watermark.Label.TextColor3 = Color3.new(1, 0.4, 0.7)
    else
        watermark.Label.TextColor3 = Color3.new(1, 1, 1)
    end
end

function createInfoGui()
    if infoGui then
        infoGui:Destroy()
    end
    
    local screenGui = Instance.new("ScreenGui")
    screenGui.Name = "AimlockInfo"
    screenGui.Parent = game.CoreGui
    screenGui.ResetOnSpawn = false
    
    table.insert(createdObjects, screenGui)
    
    local infoLabel = Instance.new("TextLabel")
    infoLabel.Size = UDim2.new(0, 250, 0, 80)
    infoLabel.Position = UDim2.new(0, 10, 0, 10)
    infoLabel.BackgroundColor3 = Color3.new(0, 0, 0)
    infoLabel.BackgroundTransparency = 0.7
    infoLabel.TextColor3 = Color3.new(1, 1, 1)
    infoLabel.Text = "AIMLOCK by Nova\n" ..
                     "Radius: " .. SETTINGS.MAX_RADIUS .. "px\n" ..
                     "FOV: " .. SETTINGS.FOV_ANGLE .. "¬∞\n" ..
                     "Camera FOV: " .. SETTINGS.CAMERA_FOV .. "¬∞\n" ..
                     "Hold RMB to activate"
    infoLabel.Font = Enum.Font.GothamBold
    infoLabel.TextSize = 14
    infoLabel.TextXAlignment = Enum.TextXAlignment.Left
    infoLabel.TextYAlignment = Enum.TextYAlignment.Top
    infoLabel.Parent = screenGui
    
    infoGui = screenGui

    delay(5, function()
        if infoGui then
            infoGui:Destroy()
            infoGui = nil
        end
    end)
    
    return infoGui
end

function getMousePosition()
    return Vector2.new(mouse.X, mouse.Y)
end

function getAngleBetween(v1, v2)
    local dot = v1.Unit:Dot(v2.Unit)
    dot = math.clamp(dot, -1, 1)
    return math.deg(math.acos(dot))
end

-- –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è: –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–π —Å –ø–æ–º–æ—â—å—é Raycast
function hasClearLineOfSight(origin, targetPart)
    if not SETTINGS.OBSTACLE_CHECK then
        return true
    end
    
    local direction = (targetPart.Position - origin).Unit
    local distance = (targetPart.Position - origin).Magnitude
    
    local raycastParams = RaycastParams.new()
    raycastParams.FilterDescendantsInstances = {localPlayer.Character, targetPart.Parent}
    raycastParams.FilterType = Enum.RaycastFilterType.Blacklist
    raycastParams.IgnoreWater = true
    
    local raycastResult = Workspace:Raycast(origin, direction * distance, raycastParams)
    
    if raycastResult then
        -- –ï—Å–ª–∏ –ª—É—á –ø–æ–ø–∞–ª –≤ —á—Ç–æ-—Ç–æ –∫—Ä–æ–º–µ —Ü–µ–ª–µ–≤–æ–≥–æ –∏–≥—Ä–æ–∫–∞, –∑–Ω–∞—á–∏—Ç –µ—Å—Ç—å –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–µ
        local hitParent = raycastResult.Instance:FindFirstAncestorOfClass("Model")
        if hitParent ~= targetPart.Parent then
            return false
        end
    end
    
    return true
end

function findBestTarget()
    local bestTarget = nil
    local mousePos = getMousePosition()
    local localCharacter = localPlayer.Character
    local localHead = localCharacter and localCharacter:FindFirstChild("Head")
    local rayOrigin = localHead and localHead.Position or camera.CFrame.Position

    local validTargets = {}
    
    for _, player in pairs(Players:GetPlayers()) do
        if player == localPlayer then continue end
        
        local character = player.Character
        if not character then continue end
        
        local humanoid = character:FindFirstChildOfClass("Humanoid")
        if not humanoid or humanoid.Health <= 0 then continue end

        -- –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –ø–∞—Ä—Ç–æ–≤
        local targetParts = {}
        
        if SETTINGS.PRIORITIZE_LIMBS then
            -- –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –Ω–æ–≥–∏ > —Ä—É–∫–∏ > –≥–æ–ª–æ–≤–∞ > —Ç–µ–ª–æ
            local leftLeg = character:FindFirstChild("Left Leg")
            local rightLeg = character:FindFirstChild("Right Leg")
            local leftArm = character:FindFirstChild("Left Arm")
            local rightArm = character:FindFirstChild("Right Arm")
            local headPart = character:FindFirstChild("Head")
            local bodyPart = character:FindFirstChild(SETTINGS.AIM_PART) or 
                            character:FindFirstChild("UpperTorso")
            
            -- –ù–æ–≥–∏ (—Å–∞–º—ã–π –≤—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)
            if leftLeg then table.insert(targetParts, {Part = leftLeg, Type = "LEG", Priority = 4}) end
            if rightLeg then table.insert(targetParts, {Part = rightLeg, Type = "LEG", Priority = 4}) end
            -- –†—É–∫–∏
            if leftArm then table.insert(targetParts, {Part = leftArm, Type = "ARM", Priority = 3}) end
            if rightArm then table.insert(targetParts, {Part = rightArm, Type = "ARM", Priority = 3}) end
            -- –ì–æ–ª–æ–≤–∞
            if headPart then table.insert(targetParts, {Part = headPart, Type = "HEAD", Priority = 2}) end
            -- –¢–µ–ª–æ (—Å–∞–º—ã–π –Ω–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)
            if bodyPart then table.insert(targetParts, {Part = bodyPart, Type = "BODY", Priority = 1}) end
        else
            -- –°—Ç–∞—Ä—ã–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –≥–æ–ª–æ–≤–∞ > —Ç–µ–ª–æ
            local headPart = character:FindFirstChild("Head")
            local bodyPart = character:FindFirstChild(SETTINGS.AIM_PART) or 
                            character:FindFirstChild("UpperTorso")
            
            if headPart then table.insert(targetParts, {Part = headPart, Type = "HEAD", Priority = 2}) end
            if bodyPart then table.insert(targetParts, {Part = bodyPart, Type = "BODY", Priority = 1}) end
        end
        
        for _, targetInfo in ipairs(targetParts) do
            local targetPart = targetInfo.Part

            local distance3D = (rayOrigin - targetPart.Position).Magnitude
            if distance3D > SETTINGS.MAX_DISTANCE then continue end

            local cameraLook = camera.CFrame.LookVector
            local toTarget = (targetPart.Position - camera.CFrame.Position)
            local angle = getAngleBetween(cameraLook, toTarget)
            
            if angle > SETTINGS.FOV_ANGLE / 2 then continue end

            local screenPoint, onScreen = camera:WorldToScreenPoint(targetPart.Position)
            if not onScreen then continue end

            local screenPos = Vector2.new(screenPoint.X, screenPoint.Y)
            local distanceToCursor = (screenPos - mousePos).Magnitude

            if distanceToCursor > SETTINGS.MAX_RADIUS then continue end

            table.insert(validTargets, {
                Part = targetPart,
                Player = player,
                DistanceToCursor = distanceToCursor,
                Distance3D = distance3D,
                ScreenPosition = screenPos,
                Angle = angle,
                Type = targetInfo.Type,
                Priority = targetInfo.Priority
            })
        end
    end
    
    if #validTargets == 0 then
        return nil
    end

    -- –°–û–†–¢–ò–†–û–í–ö–ê: –≥–ª–∞–≤–Ω—ã–π –∫—Ä–∏—Ç–µ—Ä–∏–π - —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ –∫—É—Ä—Å–æ—Ä–∞
    table.sort(validTargets, function(a, b)
        -- –°–Ω–∞—á–∞–ª–∞ —Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—é –¥–æ –∫—É—Ä—Å–æ—Ä–∞ (—Å–∞–º—ã–π –≥–ª–∞–≤–Ω—ã–π –∫—Ä–∏—Ç–µ—Ä–∏–π)
        if a.DistanceToCursor ~= b.DistanceToCursor then
            return a.DistanceToCursor < b.DistanceToCursor
        end
        
        -- –ï—Å–ª–∏ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ –∫—É—Ä—Å–æ—Ä–∞ –æ–¥–∏–Ω–∞–∫–æ–≤–æ–µ, —Ç–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –ø–∞—Ä—Ç–æ–≤
        if SETTINGS.PRIORITIZE_LIMBS and a.Priority ~= b.Priority then
            return a.Priority > b.Priority
        end
        
        -- –ï—Å–ª–∏ –≤—Å—ë –æ–¥–∏–Ω–∞–∫–æ–≤–æ–µ, –∏—Å–ø–æ–ª—å–∑—É–µ–º 3D –¥–∏—Å—Ç–∞–Ω—Ü–∏—é
        return a.Distance3D < b.Distance3D
    end)
    
    -- –¢–µ–ø–µ—Ä—å –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è —Ç–æ–ª—å–∫–æ –¥–ª—è –ª—É—á—à–µ–π —Ü–µ–ª–∏
    bestTarget = validTargets[1]
    
    if SETTINGS.OBSTACLE_CHECK then
        -- –ï—Å–ª–∏ –ª—É—á—à–∞—è —Ü–µ–ª—å - –∫–æ–Ω–µ—á–Ω–æ—Å—Ç—å –∏ –µ—Å—Ç—å –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–µ, –∏—â–µ–º —Å–ª–µ–¥—É—é—â—É—é –¥–æ—Å—Ç—É–ø–Ω—É—é —Ü–µ–ª—å
        if bestTarget.Type == "LEG" or bestTarget.Type == "ARM" then
            if not hasClearLineOfSight(rayOrigin, bestTarget.Part) then
                -- –ò—â–µ–º —Å–ª–µ–¥—É—é—â—É—é —Ü–µ–ª—å –±–µ–∑ –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–π
                for i = 2, #validTargets do
                    local nextTarget = validTargets[i]
                    -- –î–ª—è –∫–æ–Ω–µ—á–Ω–æ—Å—Ç–µ–π –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è, –¥–ª—è –≥–æ–ª–æ–≤—ã –∏ —Ç–µ–ª–∞ - –Ω–µ—Ç
                    if nextTarget.Type == "HEAD" or nextTarget.Type == "BODY" or 
                       hasClearLineOfSight(rayOrigin, nextTarget.Part) then
                        bestTarget = nextTarget
                        bestTarget.HasObstacle = false
                        break
                    end
                end
            else
                bestTarget.HasObstacle = false
            end
        else
            bestTarget.HasObstacle = false
        end
    else
        bestTarget.HasObstacle = false
    end
    
    return bestTarget
end

function aimAtTarget()
    local targetInfo = findBestTarget()
    if not targetInfo then return end

    camera.CFrame = CFrame.new(camera.CFrame.Position, targetInfo.Part.Position)

    if math.random(1, 20) == 1 then
        local obstacleInfo = targetInfo.HasObstacle and " [SWITCHED DUE TO OBSTACLE]" or ""
        print(string.format("üéØ Aiming at %s's %s (cursor: %.1fpx/%d, 3D: %.1f)%s", 
              targetInfo.Player.Name, targetInfo.Type, 
              targetInfo.DistanceToCursor, SETTINGS.MAX_RADIUS,
              targetInfo.Distance3D, obstacleInfo))
    end
end

function createCrosshair()
    if currentCrosshair then
        currentCrosshair:Destroy()
    end
    
    local screenGui = Instance.new("ScreenGui")
    screenGui.Name = "AimAssistCrosshair"
    screenGui.Parent = game.CoreGui
    screenGui.ResetOnSpawn = false

    table.insert(createdObjects, screenGui)
    
    local centerDot = Instance.new("Frame")
    centerDot.Size = UDim2.new(0, 6, 0, 6)
    centerDot.AnchorPoint = Vector2.new(0.5, 0.5)
    centerDot.BackgroundColor3 = PURPLE_COLOR
    centerDot.BorderSizePixel = 0
    centerDot.ZIndex = 999

    local dotConnection
    dotConnection = RunService.RenderStepped:Connect(function()
        if centerDot and centerDot.Parent then
            local mousePos = getMousePosition()
            centerDot.Position = UDim2.new(0, mousePos.X, 0, mousePos.Y)
        else
            dotConnection:Disconnect()
        end
    end)
    
    table.insert(connections, dotConnection)
    centerDot.Parent = screenGui

    if SETTINGS.SHOW_RADIUS_CIRCLE then
        local radiusCircle = Instance.new("Frame")
        radiusCircle.Size = UDim2.new(0, SETTINGS.MAX_RADIUS * 2, 0, SETTINGS.MAX_RADIUS * 2)
        radiusCircle.AnchorPoint = Vector2.new(0.5, 0.5)
        radiusCircle.BackgroundColor3 = Color3.new(1, 1, 1)
        radiusCircle.BackgroundTransparency = 1
        radiusCircle.BorderSizePixel = 2
        radiusCircle.BorderColor3 = PURPLE_COLOR
        radiusCircle.BorderMode = Enum.BorderMode.Outline
        radiusCircle.ZIndex = 998

        local stroke = Instance.new("UIStroke")
        stroke.Color = PURPLE_COLOR
        stroke.Thickness = 2
        stroke.Transparency = SETTINGS.CIRCLE_TRANSPARENCY
        stroke.Parent = radiusCircle

        local corner = Instance.new("UICorner")
        corner.CornerRadius = UDim.new(1, 0)
        corner.Parent = radiusCircle

        local circleConnection
        circleConnection = RunService.RenderStepped:Connect(function()
            if radiusCircle and radiusCircle.Parent then
                local mousePos = getMousePosition()
                radiusCircle.Position = UDim2.new(0, mousePos.X, 0, mousePos.Y)
            else
                circleConnection:Disconnect()
            end
        end)
        
        table.insert(connections, circleConnection)
        radiusCircle.Parent = screenGui
    end

    currentCrosshair = screenGui
    return screenGui
end

function removeCrosshair()
    if currentCrosshair then
        currentCrosshair:Destroy()
        currentCrosshair = nil
    end
end

-- Store input connections
local inputBeganConnection = UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then return end
    
    if input.UserInputType == SETTINGS.AIM_KEY then
        isAiming = true

        updateWatermarkColor()
        
        local circleStatus = SETTINGS.SHOW_RADIUS_CIRCLE and "ON (OUTLINE)" or "OFF"
        print("üî´ AIM ACTIVATED - Looking for targets within " .. SETTINGS.MAX_RADIUS .. "px from cursor - Max Distance: " .. SETTINGS.MAX_DISTANCE .. " - Circle: " .. circleStatus)

        createCrosshair()

        aimConnection = RunService.RenderStepped:Connect(function()
            if isAiming then
                aimAtTarget()
            end
        end)
        
        table.insert(connections, aimConnection)
    end
end)

table.insert(connections, inputBeganConnection)

local inputEndedConnection = UserInputService.InputEnded:Connect(function(input, gameProcessed)
    if input.UserInputType == SETTINGS.AIM_KEY then
        isAiming = false

        updateWatermarkColor()
        
        if aimConnection then
            aimConnection:Disconnect()
            aimConnection = nil
        end

        removeCrosshair()
        
        print("üî´ AIM DEACTIVATED")
    end
end)

table.insert(connections, inputEndedConnection)

-- –ù–æ–≤—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª: –≥–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏ Y –∏ T
local newInputConnection = UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then return end

    if input.KeyCode == Enum.KeyCode.Y then
        local scriptObj = localPlayer.PlayerScripts:FindFirstChild("CharacterAndBeamMove")
        if scriptObj then
            scriptObj.Enabled = not(scriptObj.Enabled)
            local status = scriptObj.Enabled
            print("Anti Lag:", status and "OFF" or "ON") -- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: ON –∫–æ–≥–¥–∞ –≤—ã–∫–ª—é—á–µ–Ω, OFF –∫–æ–≥–¥–∞ –≤–∫–ª—é—á–µ–Ω
            showNotification("ANTI LAG", not status, 3) -- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: –∏–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º —Å—Ç–∞—Ç—É—Å –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        end
    elseif input.KeyCode == Enum.KeyCode.T then
        respawnToggle = not respawnToggle
        print("Respawn loop:", respawnToggle and "ON" or "OFF")
        showNotification("RESPAWN LOOP", respawnToggle, 3)
        
        while respawnToggle and task.wait() do
            local Char = me.Character or me.CharacterAdded:wait()
            local Hum = Char and Char:FindFirstChild("Humanoid")
            if Hum then
                Hum.Health = 0
            end
        end
    end
end)

table.insert(connections, newInputConnection)

function setAimRadius(newRadius)
    SETTINGS.MAX_RADIUS = newRadius
    saveSettings() -- –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    print("üéØ Aim radius updated to: " .. newRadius .. "px")

    if isAiming then
        createCrosshair()
    end
end

function toggleRadiusCircle()
    SETTINGS.SHOW_RADIUS_CIRCLE = not SETTINGS.SHOW_RADIUS_CIRCLE
    saveSettings() -- –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    local newStatus = SETTINGS.SHOW_RADIUS_CIRCLE and "ENABLED (OUTLINE)" or "DISABLED"
    print("üéØ Radius circle: " .. newStatus)

    if isAiming then
        createCrosshair()
    end
    
    return newStatus
end

function setCircleTransparency(transparency)
    SETTINGS.CIRCLE_TRANSPARENCY = math.clamp(transparency, 0, 1)
    saveSettings() -- –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    print("üéØ Circle transparency updated to: " .. SETTINGS.CIRCLE_TRANSPARENCY)

    if isAiming then
        createCrosshair()
    end
end

-- –§—É–Ω–∫—Ü–∏—è –ø–æ–ª–Ω–æ–π –≤—ã–≥—Ä—É–∑–∫–∏ —Å–∫—Ä–∏–ø—Ç–∞
function unloadScript()
    print("üîÑ Starting script unload...")
    
    -- –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤–µ–±—Ö—É–∫ –æ –≤—ã–≥—Ä—É–∑–∫–µ
    sendWebhook(string.format("üî¥ **Aimlock Unloaded**\n**Player:** %s (%s)\n**Time:** %s",
        localPlayer.DisplayName, localPlayer.Name, os.date("%Y-%m-%d %H:%M:%S")))
    
    -- –û—Ç–∫–ª—é—á–∞–µ–º –≤—Å–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
    for _, connection in ipairs(connections) do
        if connection and typeof(connection) == "RBXScriptConnection" then
            connection:Disconnect()
        end
    end
    
    -- –û—á–∏—â–∞–µ–º —Ç–∞–±–ª–∏—Ü—É —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
    connections = {}
    
    -- –£–¥–∞–ª—è–µ–º –≤—Å–µ —Å–æ–∑–¥–∞–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã
    for _, obj in ipairs(createdObjects) do
        if obj and obj.Parent then
            obj:Destroy()
        end
    end
    
    -- –û—á–∏—â–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –æ–±—ä–µ–∫—Ç–æ–≤
    createdObjects = {}
    
    -- –û—Ç–∫–ª—é—á–∞–µ–º aim —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –µ—Å–ª–∏ –∞–∫—Ç–∏–≤–Ω–æ
    if aimConnection then
        aimConnection:Disconnect()
        aimConnection = nil
    end
    
    -- –£–¥–∞–ª—è–µ–º –≤–æ–¥—è–Ω–æ–π –∑–Ω–∞–∫
    if watermark and watermark.Gui then
        watermark.Gui:Destroy()
        watermark = nil
    end
    
    -- –£–¥–∞–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–π GUI
    if infoGui then
        infoGui:Destroy()
        infoGui = nil
    end
    
    -- –£–¥–∞–ª—è–µ–º –ø—Ä–∏—Ü–µ–ª
    removeCrosshair()
    
    -- –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    isAiming = false
    
    print("‚úÖ Aimlock successfully unloaded!")
    
    -- –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞
    return true
end

-- Initialize
createWatermark()
createInfoGui()

-- Store heartbeat connection
local heartbeatConnection = RunService.Heartbeat:Connect(function()
    checkForBotCommands()
end)
table.insert(connections, heartbeatConnection)

-- Store chat connection
local chatConnection = localPlayer.Chatted:Connect(function(message)
    local lowerMessage = message:lower()
    if lowerMessage:sub(1, 7) == "!radius" then
        local newRadius = tonumber(lowerMessage:sub(9))
        if newRadius and newRadius > 0 then
            setAimRadius(newRadius)
        else
            print("‚ùå Invalid radius. Usage: !radius [number]")
        end
    elseif lowerMessage:sub(1, 4) == "!fov" then
        local newFOV = tonumber(lowerMessage:sub(6))
        if newFOV then
            setCameraFOV(newFOV)
        else
            print("‚ùå Invalid FOV. Usage: !fov [1-120]")
        end
    elseif lowerMessage == "!circle" or lowerMessage == "!togglecircle" then
        toggleRadiusCircle()
    elseif lowerMessage:sub(1, 14) == "!transparency" then
        local transparency = tonumber(lowerMessage:sub(16))
        if transparency and transparency >= 0 and transparency <= 1 then
            setCircleTransparency(transparency)
        else
            print("‚ùå Invalid transparency. Usage: !transparency [0-1]")
        end
    elseif lowerMessage == "!save" then
        if saveSettings() then
            print("üíæ Settings saved successfully!")
        else
            print("‚ùå Failed to save settings")
        end
    elseif lowerMessage == "!load" then
        local loaded = loadSettings()
        if loaded then
            SETTINGS = loaded
            -- –ü—Ä–∏–º–µ–Ω—è–µ–º –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π FOV –∫–∞–º–µ—Ä—ã
            if SETTINGS.CAMERA_FOV then
                camera.FieldOfView = SETTINGS.CAMERA_FOV
            end
            print("üíæ Settings loaded successfully!")
            if isAiming then
                createCrosshair()
            end
        else
            print("‚ùå Failed to load settings")
        end
    elseif lowerMessage == "!reset" then
        SETTINGS = DEFAULT_SETTINGS
        -- –ü—Ä–∏–º–µ–Ω—è–µ–º FOV –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        camera.FieldOfView = SETTINGS.CAMERA_FOV
        saveSettings()
        print("üîÑ Settings reset to defaults")
        if isAiming then
            createCrosshair()
        end
    elseif lowerMessage == "!settings" then
        print("üìä Current Settings:")
        print("   ‚Ä¢ Radius: " .. SETTINGS.MAX_RADIUS .. "px")
        print("   ‚Ä¢ FOV: " .. SETTINGS.FOV_ANGLE .. "¬∞")
        print("   ‚Ä¢ Camera FOV: " .. SETTINGS.CAMERA_FOV .. "¬∞")
        print("   ‚Ä¢ Circle: " .. (SETTINGS.SHOW_RADIUS_CIRCLE and "ENABLED" or "DISABLED"))
        print("   ‚Ä¢ Circle Transparency: " .. SETTINGS.CIRCLE_TRANSPARENCY)
    elseif lowerMessage == "!unload" then
        unloadScript()
        return -- –ü—Ä–µ—Ä—ã–≤–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–æ—Å–ª–µ –≤—ã–≥—Ä—É–∑–∫–∏
    elseif lowerMessage == "!help" then
        print("üéØ AIMLOCK Commands:")
        print("!radius [number] - Change aim radius")
        print("!fov [1-120] - Change camera FOV angle")
        print("!circle - Toggle radius circle visibility")
        print("!transparency [0-1] - Set circle outline transparency")
        print("!save - Force save settings")
        print("!load - Force load settings")
        print("!reset - Reset to default settings")
        print("!settings - Show current settings")
        print("!unload - Completely unload the aimlock script")
        print("!help - Show this help")
    end
end)
table.insert(connections, chatConnection)

-- Send startup webhook
delay(2, function()
    sendStartupWebhook()
end)

print("üéØ AIMLOCK v4 by Nova LOADED!")
print("üíæ Settings: " .. (loadedSettings and "LOADED FROM FILE" or "DEFAULT"))
print("Aim Radius: " .. SETTINGS.MAX_RADIUS .. "px")
print("Camera FOV: " .. SETTINGS.CAMERA_FOV .. "¬∞")
print("Circle Transparency: " .. SETTINGS.CIRCLE_TRANSPARENCY)
print("Aim Mode: CURSOR-BASED (follows mouse position)")
print("Hotkeys: Y - Anti Lag, T - Respawn Loop")
print("Hold RMB to activate")
print("Type !unload to completely unload the script")
